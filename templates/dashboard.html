{% extends "layout.html" %}

{% block title %}Publishing Dashboard{% endblock %}

{% block head %}
<style>
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .platform-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.2s;
    }

    .platform-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
    }

    .platform-name {
        font-weight: 600;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        text-transform: capitalize;
    }

    .log-container {
        background-color: #000;
        color: #0f0;
        font-family: 'Courier New', Courier, monospace;
        padding: 1rem;
        border-radius: 0.5rem;
        height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #64748b;
        margin-right: 5px;
    }

    .status-indicator.running {
        background-color: #eab308;
        box-shadow: 0 0 10px #eab308;
    }

    .status-indicator.idle {
        background-color: #22c55e;
    }

    .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 2rem;">
    <div class="header-actions">
        <h2>üöÄ Control Center</h2>
        <span id="status-badge"
            style="padding: 0.5rem 1rem; background: var(--sidebar-bg); border-radius: 20px; border: 1px solid var(--border-color); font-size: 0.9rem;">
            <span class="status-indicator idle"></span> Ready
        </span>
    </div>
    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Trigger posts to all configured platforms or select individual ones.
    </p>
    <button onclick="startPublishing()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
        ‚ö° Publish to ALL Platforms
    </button>
</div>

<h3 style="margin-bottom: 1rem;">Individual Modules</h3>
<div class="actions-grid">
    {% for module in modules %}
    <div class="platform-card">
        <div class="platform-name">{{ module.replace('_', ' ').replace('posting', '') }}</div>
        <button onclick="startPublishing('{{ module }}')" class="btn btn-primary"
            style="width: 100%; font-size: 0.9rem;">
            Publish
        </button>
    </div>
    {% endfor %}
</div>

<h3 style="margin-bottom: 1rem;">Live Logs</h3>
<div class="log-container" id="log-output">Waiting for action...</div>

<div class="card" style="margin-top: 2rem; border-color: #eab308; display: none;" id="report-card">
    <div class="header-actions" style="margin-bottom: 1rem;">
        <h3 style="margin: 0;">üìä Latest Run Report</h3>
        <span style="font-size: 0.9rem; color: var(--text-muted);">Results from run at <span
                id="report-time"></span></span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
        <div
            style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1.5rem; text-align: center;">
            <div id="success-count" style="font-size: 2rem; font-weight: bold; color: #22c55e; margin-bottom: 0.5rem;">-
            </div>
            <div style="color: #22c55e; font-weight: 600;">‚úÖ Successful Posts</div>
        </div>
        <div
            style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; padding: 1.5rem; text-align: center;">
            <div id="fail-count" style="font-size: 2rem; font-weight: bold; color: #ef4444; margin-bottom: 0.5rem;">-
            </div>
            <div style="color: #ef4444; font-weight: 600;">‚ùå Failed Posts</div>
        </div>
    </div>

    <h4 style="margin-bottom: 1rem; color: #ef4444;">üìã Failed Credentials Detail</h4>
    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;"
        id="failed-creds-list">
        <!-- Dynamic Content -->
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function startPublishing(platform = null) {
        const logContainer = document.getElementById('log-output');
        const statusBadge = document.querySelector('.status-indicator');
        const reportCard = document.getElementById('report-card');

        // Hide previous report
        reportCard.style.display = 'none';

        logContainer.innerHTML = "Initializing...\n";
        statusBadge.className = 'status-indicator running';
        statusBadge.nextSibling.textContent = " Running...";

        fetch('/publish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ platform: platform })
        })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            statusBadge.className = 'status-indicator idle';
                            statusBadge.nextSibling.textContent = " Completed";
                            logContainer.innerHTML += "\n--- END ---\n";
                            logContainer.scrollTop = logContainer.scrollHeight;
                            fetchReport(); // Fetch report after completion
                            return;
                        }
                        const chunk = decoder.decode(value);
                        logContainer.innerHTML += chunk;
                        logContainer.scrollTop = logContainer.scrollHeight;
                        read();
                    });
                }
                read();
            })
            .catch(error => {
                logContainer.innerHTML += `\nError: ${error}`;
                statusBadge.className = 'status-indicator idle';
            });
    }

    function fetchReport() {
        fetch('/report')
            .then(res => res.json())
            .then(data => {
                if (data.error) return;

                document.getElementById('report-card').style.display = 'block';
                document.getElementById('report-time').textContent = data.timestamp;
                document.getElementById('success-count').textContent = data.success_count;
                document.getElementById('fail-count').textContent = data.fail_count;

                const listContainer = document.getElementById('failed-creds-list');
                listContainer.innerHTML = '';

                if (data.failed_credentials.length === 0) {
                    listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">No failures recorded! üéâ</div>';
                    return;
                }

                data.failed_credentials.forEach((item, index) => {
                    const credsStr = JSON.stringify(item.credentials, null, 2);
                    const errorMsg = item.error ? `Error: ${item.error}` : 'Unknown Issue';

                    const moduleHtml = `
                    <div style="padding: 1rem; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2);">
                        <strong style="color: #ef4444;">Module: ${item.module}</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">${errorMsg}</div>
                    </div>
                `;

                    const credsHtml = `
                    <div style="padding: 1rem; font-family: monospace; font-size: 0.85rem; background: rgba(0,0,0,0.1);">
                        <pre style="margin: 0; white-space: pre-wrap;">${credsStr}</pre>
                    </div>
                `;

                    const div = document.createElement('div');
                    div.innerHTML = moduleHtml + credsHtml;
                    listContainer.appendChild(div);
                });
            });
    }
</script>
{% endblock %}