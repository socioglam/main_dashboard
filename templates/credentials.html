{% extends "layout.html" %}

{% block title %}Manage Credentials{% endblock %}

{% block content %}
<div class="card">
    <div style="margin-bottom: 2rem;">
        <label for="platform-select">Select Platform</label>
        <select id="platform-select" onchange="loadPlatformConfig()" style="max-width: 400px;">
            <option value="" disabled selected>-- Choose a Platform --</option>
            {% for key in module_keys %}
            <option value="{{ key }}">{{ key.replace('_', ' ').title() }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="config-area" style="display: none;">
        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">

            <!-- Existing Accounts List -->
            <div style="flex: 1; min-width: 300px;">
                <h2>Current Accounts</h2>
                <div id="accounts-list" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Add New Account Form -->
            <div
                style="flex: 1; min-width: 300px; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                <h2>Add New Credential</h2>
                <p class="text-muted" style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                    Fill in the fields below.
                </p>
                <form id="add-credential-form" onsubmit="saveCredential(event)">
                    <div id="dynamic-form-fields">
                        <!-- Dynamic fields go here -->
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                        Save Credential
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPlatform = '';
    let currentSchema = [];

    async function loadPlatformConfig() {
        const select = document.getElementById('platform-select');
        const platform = select.value;
        currentPlatform = platform;

        const response = await fetch(`/api/credentials/${platform}`);
        const data = await response.json();

        document.getElementById('config-area').style.display = 'block';
        renderAccounts(data.accounts);
        renderForm(data.schema);
    }

    function renderAccounts(accounts) {
        const list = document.getElementById('accounts-list');
        list.innerHTML = '';

        if (accounts.length === 0) {
            list.innerHTML = '<p style="color: var(--text-muted);">No accounts configured yet.</p>';
            return;
        }

        accounts.forEach((acc, index) => {
            const item = document.createElement('div');
            item.style.padding = '1rem';
            item.style.backgroundColor = 'var(--bg-color)';
            item.style.border = '1px solid var(--border-color)';
            item.style.borderRadius = '0.5rem';

            // Try to find a good "title" key
            const titleKey = Object.keys(acc).find(k => k.includes('name') || k.includes('user') || k.includes('email') || k.includes('handle')) || Object.keys(acc)[0];
            const title = acc[titleKey] || `Account #${index + 1}`;

            item.innerHTML = `<strong>${title}</strong><div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; overflow-x: auto;"><pre>${JSON.stringify(acc, null, 2)}</pre></div>`;
            list.appendChild(item);
        });
    }

    function renderForm(schema) {
        const container = document.getElementById('dynamic-form-fields');
        container.innerHTML = '';
        currentSchema = schema;

        if (schema.length === 0) {
            container.innerHTML = '<p>No schema detected. Please verify the backend.</p>';
            return;
        }

        schema.forEach(key => {
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label for="field-${key}">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>
                <input type="text" id="field-${key}" name="${key}" required>
            `;
            container.appendChild(div);
        });
    }

    async function saveCredential(e) {
        e.preventDefault();
        const formData = {};

        currentSchema.forEach(key => {
            formData[key] = document.getElementById(`field-${key}`).value;
        });

        try {
            const response = await fetch('/credentials/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    platform: currentPlatform,
                    account_data: formData
                })
            });

            if (response.ok) {
                alert('Credential added successfully!');
                document.getElementById('add-credential-form').reset();
                loadPlatformConfig(); // Refresh list
            } else {
                alert('Failed to save credential.');
            }
        } catch (err) {
            console.error(err);
            alert('Error saving credential.');
        }
    }
</script>
{% endblock %}